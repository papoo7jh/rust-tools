name: 🔄 Sync master with latest tag

on:
  push:
    tags:
      - 'latest'

permissions:
  contents: write  # nécessaire pour pousser sur master
  actions: write

jobs:
  update-master:
    name: 🧬 Update master branch to match the tag commit
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # on récupère tous les tags et l'historique

      - name: 📛 Get latest tag and commit info
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Latest tag: $TAG_NAME"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout master
          
          # 🔀 On applique le tag (fast-forward)
          git merge --ff-only "$TAG_NAME"

          # 🛡️ Supprime les fichiers de workflows du staging pour éviter les erreurs
          git restore --staged .github/workflows || true
          git restore .github/workflows || true

          # ✅ Commit uniquement si il reste des modifs utiles
          if ! git diff --cached --quiet; then
            git commit -m "Sync master with tag $TAG_NAME (excluding workflows)"
          else
            echo "✅ Nothing to commit"
          fi

      - name: 🚀 Push updated master branch
        run: |
          git push origin master
